#!/usr/bin/env bash
#
# Test runner for /mind/concepts/delete
#

set -e

BRANE_ROOT="$(cd "$(dirname "$0")/../../../.." && pwd)"
INPUT=$(cat)
WORKDIR=$(mktemp -d)
trap "rm -rf $WORKDIR" EXIT
cd "$WORKDIR"

init_mind() {
  mkdir -p .brane
  sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
  echo '{}' | bun run "$BRANE_ROOT/src/cli.ts" /mind/init > /dev/null 2>&1
}

create_concept() {
  echo "$1" | bun run "$BRANE_ROOT/src/cli.ts" /mind/concepts/create > /dev/null 2>&1
}

case "$TC_CASE_NAME" in
  00-success-delete)
    init_mind
    create_concept '{"name": "ToDelete", "type": "Entity"}'
    ;;
  01-error-not-found)
    init_mind
    ;;
  02-error-missing-id)
    init_mind
    ;;
esac

echo "$INPUT" | bun run "$BRANE_ROOT/src/cli.ts" /mind/concepts/delete
