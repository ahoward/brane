#!/usr/bin/env bash
#
# Test runner for /body/fts/index
#
# Each test case runs in an isolated temp directory.
# TC_CASE_NAME environment variable determines setup.
#

set -e

# Get the original directory (where brane source lives)
BRANE_ROOT="$(cd "$(dirname "$0")/../../../.." && pwd)"

# Read input from stdin
INPUT=$(cat)

# Create isolated temp directory
WORKDIR=$(mktemp -d)
trap "rm -rf $WORKDIR" EXIT

cd "$WORKDIR"

# Helper to add files to body.db
add_file() {
  local url="$1"
  local hash="$2"
  local size="$3"
  local mtime="$4"
  sqlite3 .brane/body.db "INSERT INTO files (url, hash, size, mtime) VALUES ('$url', '$hash', $size, $mtime);"
}

# Helper to add FTS index status
add_fts_status() {
  local url="$1"
  local hash="$2"
  sqlite3 .brane/body.db "INSERT INTO files_fts_status (url, indexed_hash) VALUES ('$url', '$hash');"
}

# Helper to add FTS content
add_fts_content() {
  local url="$1"
  local content="$2"
  sqlite3 .brane/body.db "INSERT INTO files_fts (url, content) VALUES ('$url', '$content');"
}

# Initialize brane with FTS tables
init_brane() {
  mkdir -p .brane
  sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
  sqlite3 .brane/body.db "CREATE VIRTUAL TABLE IF NOT EXISTS files_fts USING fts5(url, content);"
  sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files_fts_status (url TEXT PRIMARY KEY, indexed_hash TEXT NOT NULL);"
}

# Setup based on test case name
case "$TC_CASE_NAME" in
  00-success-index-files)
    # Create files and track them, then index
    init_brane
    echo "hello world" > hello.txt
    echo "function foo() { return 42; }" > code.js
    HASH1=$(sha256sum hello.txt | cut -d' ' -f1)
    SIZE1=$(stat -c%s hello.txt)
    MTIME1=$(stat -c%Y hello.txt)
    add_file "file://$WORKDIR/hello.txt" "$HASH1" "$SIZE1" "$MTIME1"
    HASH2=$(sha256sum code.js | cut -d' ' -f1)
    SIZE2=$(stat -c%s code.js)
    MTIME2=$(stat -c%Y code.js)
    add_file "file://$WORKDIR/code.js" "$HASH2" "$SIZE2" "$MTIME2"
    ;;

  01-success-incremental)
    # Index some files, then add new file
    init_brane
    echo "already indexed" > indexed.txt
    echo "new file" > new.txt
    HASH1=$(sha256sum indexed.txt | cut -d' ' -f1)
    SIZE1=$(stat -c%s indexed.txt)
    MTIME1=$(stat -c%Y indexed.txt)
    add_file "file://$WORKDIR/indexed.txt" "$HASH1" "$SIZE1" "$MTIME1"
    add_fts_status "file://$WORKDIR/indexed.txt" "$HASH1"
    add_fts_content "file://$WORKDIR/indexed.txt" "already indexed"
    HASH2=$(sha256sum new.txt | cut -d' ' -f1)
    SIZE2=$(stat -c%s new.txt)
    MTIME2=$(stat -c%Y new.txt)
    add_file "file://$WORKDIR/new.txt" "$HASH2" "$SIZE2" "$MTIME2"
    ;;

  02-success-skip-binary)
    # Create text and binary files
    init_brane
    echo "text file" > text.txt
    # Create binary file (null bytes)
    printf '\x00\x01\x02\x03' > binary.bin
    HASH1=$(sha256sum text.txt | cut -d' ' -f1)
    SIZE1=$(stat -c%s text.txt)
    MTIME1=$(stat -c%Y text.txt)
    add_file "file://$WORKDIR/text.txt" "$HASH1" "$SIZE1" "$MTIME1"
    HASH2=$(sha256sum binary.bin | cut -d' ' -f1)
    SIZE2=$(stat -c%s binary.bin)
    MTIME2=$(stat -c%Y binary.bin)
    add_file "file://$WORKDIR/binary.bin" "$HASH2" "$SIZE2" "$MTIME2"
    ;;

  03-success-path-filter)
    # Create files in different directories
    init_brane
    mkdir -p src tests
    echo "source code" > src/main.ts
    echo "test code" > tests/main.test.ts
    echo "root file" > root.txt
    HASH1=$(sha256sum src/main.ts | cut -d' ' -f1)
    SIZE1=$(stat -c%s src/main.ts)
    MTIME1=$(stat -c%Y src/main.ts)
    add_file "file://$WORKDIR/src/main.ts" "$HASH1" "$SIZE1" "$MTIME1"
    HASH2=$(sha256sum tests/main.test.ts | cut -d' ' -f1)
    SIZE2=$(stat -c%s tests/main.test.ts)
    MTIME2=$(stat -c%Y tests/main.test.ts)
    add_file "file://$WORKDIR/tests/main.test.ts" "$HASH2" "$SIZE2" "$MTIME2"
    HASH3=$(sha256sum root.txt | cut -d' ' -f1)
    SIZE3=$(stat -c%s root.txt)
    MTIME3=$(stat -c%Y root.txt)
    add_file "file://$WORKDIR/root.txt" "$HASH3" "$SIZE3" "$MTIME3"
    ;;

  04-success-force-reindex)
    # Files already indexed, force re-index
    init_brane
    echo "will be reindexed" > file.txt
    HASH=$(sha256sum file.txt | cut -d' ' -f1)
    SIZE=$(stat -c%s file.txt)
    MTIME=$(stat -c%Y file.txt)
    add_file "file://$WORKDIR/file.txt" "$HASH" "$SIZE" "$MTIME"
    add_fts_status "file://$WORKDIR/file.txt" "$HASH"
    add_fts_content "file://$WORKDIR/file.txt" "will be reindexed"
    ;;

  05-success-empty)
    # No files tracked
    init_brane
    ;;

  06-success-cleanup-stale)
    # Index has entries for files no longer tracked
    init_brane
    echo "still tracked" > current.txt
    HASH=$(sha256sum current.txt | cut -d' ' -f1)
    SIZE=$(stat -c%s current.txt)
    MTIME=$(stat -c%Y current.txt)
    add_file "file://$WORKDIR/current.txt" "$HASH" "$SIZE" "$MTIME"
    # Add stale FTS entry (file not in files table)
    add_fts_status "file://$WORKDIR/deleted.txt" "oldhash"
    add_fts_content "file://$WORKDIR/deleted.txt" "old content"
    ;;

  07-error-not-initialized)
    # Don't initialize brane
    echo "some file" > test.txt
    ;;
esac

# Run the handler
echo "$INPUT" | bun run "$BRANE_ROOT/src/cli.ts" /body/fts/index
