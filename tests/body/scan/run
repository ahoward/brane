#!/usr/bin/env bash
#
# Test runner for /body/scan
#
# Each test case runs in an isolated temp directory.
# TC_CASE_NAME environment variable determines setup.
#

set -e

# Get the original directory (where brane source lives)
BRANE_ROOT="$(cd "$(dirname "$0")/../../.." && pwd)"

# Read input from stdin
INPUT=$(cat)

# Create isolated temp directory
WORKDIR=$(mktemp -d)
trap "rm -rf $WORKDIR" EXIT

cd "$WORKDIR"

# Helper to add files to body.db
add_file() {
  local url="$1"
  local hash="$2"
  local size="$3"
  local mtime="$4"
  sqlite3 .brane/body.db "INSERT INTO files (url, hash, size, mtime) VALUES ('$url', '$hash', $size, $mtime);"
}

# Setup based on test case name
case "$TC_CASE_NAME" in
  00-success-full-scan)
    # Initialize brane, create files to be scanned
    mkdir -p .brane
    sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
    echo "file a" > a.txt
    echo "file b" > b.txt
    echo "file c" > c.txt
    ;;

  01-success-with-updates)
    # Initialize brane, add some files, modify one, add new one
    mkdir -p .brane
    sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
    echo "unchanged" > unchanged.txt
    echo "will modify" > modified.txt
    # Add them to db with current hashes
    HASH1=$(sha256sum unchanged.txt | cut -d' ' -f1)
    SIZE1=$(stat -c%s unchanged.txt)
    MTIME1=$(stat -c%Y unchanged.txt)
    add_file "file://$WORKDIR/unchanged.txt" "$HASH1" "$SIZE1" "$MTIME1"
    HASH2=$(sha256sum modified.txt | cut -d' ' -f1)
    SIZE2=$(stat -c%s modified.txt)
    MTIME2=$(stat -c%Y modified.txt)
    add_file "file://$WORKDIR/modified.txt" "$HASH2" "$SIZE2" "$MTIME2"
    # Now modify one and create new
    echo "modified content" > modified.txt
    echo "new file" > new.txt
    ;;

  02-success-with-deletes)
    # Initialize brane, add files to db, delete one from filesystem
    mkdir -p .brane
    sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
    echo "keep this" > keep.txt
    HASH=$(sha256sum keep.txt | cut -d' ' -f1)
    SIZE=$(stat -c%s keep.txt)
    MTIME=$(stat -c%Y keep.txt)
    add_file "file://$WORKDIR/keep.txt" "$HASH" "$SIZE" "$MTIME"
    # Add a file to db that doesn't exist
    add_file "file://$WORKDIR/deleted.txt" "fakehash" 100 1234567890
    ;;

  03-success-path-filter)
    # Initialize brane, create files in different directories
    mkdir -p .brane src tests
    sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
    echo "src file 1" > src/index.ts
    echo "src file 2" > src/util.ts
    echo "test file" > tests/main.test.ts
    echo "root file" > root.txt
    ;;

  04-success-dry-run)
    # Initialize brane, create files but don't add them
    mkdir -p .brane
    sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
    echo "file a" > a.txt
    echo "file b" > b.txt
    ;;

  05-success-empty)
    # Initialize brane with no files
    mkdir -p .brane
    sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
    ;;

  06-error-not-initialized)
    # Don't initialize brane
    echo "some file" > test.txt
    ;;
esac

# Run the handler
echo "$INPUT" | bun run "$BRANE_ROOT/src/cli.ts" /body/scan
