#!/usr/bin/env bash
#
# Test runner for /body/init
#
# Each test case runs in an isolated temp directory.
# TC_CASE_NAME environment variable determines setup.
#

set -e

# Get the original directory (where brane source lives)
BRANE_ROOT="$(cd "$(dirname "$0")/../../.." && pwd)"

# Read input from stdin
INPUT=$(cat)

# Create isolated temp directory
WORKDIR=$(mktemp -d)
trap "rm -rf $WORKDIR" EXIT

cd "$WORKDIR"

# Setup based on test case name
case "$TC_CASE_NAME" in
  *-idempotent*)
    # Pre-create .brane with body.db for idempotency test
    mkdir -p .brane
    sqlite3 .brane/body.db "CREATE TABLE IF NOT EXISTS files (id INTEGER PRIMARY KEY, url TEXT NOT NULL UNIQUE, hash TEXT NOT NULL, size INTEGER NOT NULL, mtime INTEGER NOT NULL);"
    ;;
  *-custom-path*)
    # Ensure custom path directory exists (clean it first)
    rm -rf /tmp/brane-test-custom
    mkdir -p /tmp/brane-test-custom
    ;;
  *-brane-is-file*)
    # Create .brane as a file, not directory
    touch .brane
    ;;
  *-relative-path*)
    # No special setup, just use the temp dir
    ;;
esac

# Run the handler
echo "$INPUT" | bun run "$BRANE_ROOT/src/cli.ts" /body/init
