#!/usr/bin/env bash
#
# Test runner for /body/files/add
#
set -e

BRANE_ROOT="$(cd "$(dirname "$0")/../../../.." && pwd)"
source "$BRANE_ROOT/tests/lib.sh"

INPUT=$(cat)
workspace

case "$TC_CASE_NAME" in
  00-success-single-file)
    init_body
    echo "hello world" > test.txt
    ;;

  01-success-multiple-files)
    init_body
    echo "file a" > a.txt
    echo "file b" > b.txt
    echo "file c" > c.txt
    ;;

  02-success-update-file)
    init_body
    echo "original content" > test.txt
    echo '{"path": "test.txt"}' | bun run "$BRANE_ROOT/src/cli.ts" /body/files/add > /dev/null
    sleep 0.1
    echo "modified content" > test.txt
    ;;

  03-success-directory)
    init_body
    mkdir -p subdir
    echo "file 1" > subdir/one.txt
    echo "file 2" > subdir/two.txt
    ;;

  04-error-not-found)
    init_body
    ;;

  05-error-not-initialized)
    echo "test content" > test.txt
    ;;

  06-success-gitignore)
    init_body
    mkdir -p ignored
    echo "keep this" > ignored/keep.txt
    echo "ignore this" > ignored/skip.log
    echo "*.log" > .gitignore
    ;;

  07-success-hidden-excluded)
    init_body
    mkdir -p with_hidden
    echo "visible" > with_hidden/visible.txt
    echo "hidden" > with_hidden/.hidden
    ;;

  08-success-hidden-included)
    init_body
    mkdir -p with_hidden
    echo "visible" > with_hidden/visible.txt
    echo "hidden" > with_hidden/.hidden
    ;;

  09-partial-success)
    init_body
    echo "exists" > exists.txt
    ;;
esac

echo "$INPUT" | bun run "$BRANE_ROOT/src/cli.ts" /body/files/add
